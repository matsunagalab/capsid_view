<div class="container mx-auto px-4">
    <!-- Simple controls -->
    <div class="bg-white p-4 rounded-lg shadow mb-4 flex items-center gap-4">
        <label for="columns" class="font-medium whitespace-nowrap">Columns:</label>
        <input type="range" id="columns" min="1" max="4" value="3" class="flex-grow">
        <span id="columns-value" class="font-medium">3</span>
    </div>
    
    <!-- Grid container -->
    <div id="grid-container" class="grid gap-4">
        <!-- Grid items will be dynamically inserted here -->
    </div>
</div>

<style>
.molecule-viewer {
    position: relative;
    width: 100%;
    height: 100%;
    background-color: #ffffff;
}
/* Molstar specific overrides */
.msp-plugin {
    position: relative !important;
    height: 100%;
}
.msp-plugin-content {
    position: relative !important;
    height: 100%;
}
.msp-viewport {
    position: relative !important;
    height: 100% !important;
}
</style>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/molstar@latest/build/viewer/molstar.css" />

<script>
// 分子構造のデータ
const structures = [
    {
        id: 'viewer1',
        name: '2buk',
        url: 'https://files.rcsb.org/download/2BUK.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer2',
        name: '4v4m',
        url: 'https://files.rcsb.org/download/4V4M.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer3',
        name: '6s44',
        url: 'https://files.rcsb.org/download/6S44.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer4',
        name: '7odw',
        url: 'https://files.rcsb.org/download/7ODW.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer5',
        name: '3r0r',
        url: 'https://files.rcsb.org/download/3R0R.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer6',
        name: '5zju',
        url: 'https://files.rcsb.org/download/5ZJU.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer7',
        name: '1stm',
        url: 'https://files.rcsb.org/download/1STM.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer8',
        name: '1vb4',
        url: 'https://files.rcsb.org/download/1VB4.pdb',
        format: 'pdb'
    },
    {
        id: 'viewer9',
        name: '1m1c',
        url: 'https://files.rcsb.org/download/1M1C.pdb',
        format: 'pdb'
    }
];

// ビューアのサイズを計算する関数
function calculateViewerSize(columns) {
    // コンテナの幅から1グリッドの幅を計算
    const container = document.querySelector('.container');
    const containerWidth = container.clientWidth;
    // パディングとギャップを考慮してグリッドサイズを計算
    const gap = 16; // gap-4 = 1rem = 16px
    const padding = 32; // p-4 = 1rem padding on each side = 32px total
    const availableWidth = containerWidth - (padding * columns) - (gap * (columns - 1));
    const size = Math.floor(availableWidth / columns);
    
    // サイズの制限を追加
    const minSize = 200;
    const maxSize = 500;
    return Math.max(minSize, Math.min(size, maxSize));
}

// グリッドアイテムを生成する関数
function createGridItem(structure, size) {
    const molstarUrl = `https://molstar.org/viewer/?pdb=${structure.name}&preset=default`;
    return `
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-2">
                <a href="${molstarUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">
                    ${structure.name}
                </a>
            </h2>
            <div id="${structure.id}" style="width: 100%; height: ${size}px;"></div>
        </div>
    `;
}

// Molstarビューアのオプション
const viewerOptions = {
    layoutIsExpanded: false,
    layoutShowControls: false,
    layoutShowRemoteState: false,
    layoutShowSequence: false,
    layoutShowLog: false,
    layoutShowLeftPanel: false,
    layoutShowStructureSourceControls: false,
    viewportShowAnimation: false,
    viewportShowExpand: false,
    viewportShowSelectionMode: false,
    viewportShowTrajectoryControls: false,
    canvas3d: {
        antialiasing: true,
        backgroundColor: { r: 255, g: 255, b: 255, a: 1 }
    }
};

// プラグインの状態を追跡
const viewers = new Map();

// グリッドを更新する関数
async function updateGrid() {
    const gridContainer = document.getElementById('grid-container');
    const columns = document.getElementById('columns').value;
    document.getElementById('columns-value').textContent = columns;

    // ビューアのサイズを計算
    const viewerSize = calculateViewerSize(columns);

    // 既存のビューアを破棄
    viewers.forEach(viewer => {
        if (viewer && viewer.plugin) {
            viewer.plugin.dispose();
        }
    });
    viewers.clear();

    // グリッドのカラム数を更新
    gridContainer.className = `grid gap-4 grid-cols-${columns}`;

    // グリッドアイテムを生成
    gridContainer.innerHTML = structures.map(structure => 
        createGridItem(structure, viewerSize)
    ).join('');

    // molstarビューアを初期化
    for (const structure of structures) {
        try {
            const viewer = await molstar.Viewer.create(
                structure.id,
                { ...viewerOptions, canvas3d: { ...viewerOptions.canvas3d } }
            );
            
            viewers.set(structure.id, viewer);
            
            await viewer.loadStructureFromUrl(
                structure.url,
                structure.format
            ).then(() => {
                const plugin = viewer.plugin;
                const state = plugin.state.data;
                const update = state.build()
                    .update(state.select('structure-representation'), (old) => {
                        return {
                            ...old,
                            type: 'cartoon',
                            color: 'chain-id'
                        };
                    });
                plugin.runTask(plugin.state.updateTree(update));
            });

        } catch (error) {
            console.error(`Error initializing viewer for ${structure.name}:`, error);
        }
    }
}

// ウィンドウリサイズ時にグリッドを更新
let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(updateGrid, 100);
});

// スライダーの変更イベントを監視
document.getElementById('columns').addEventListener('input', updateGrid);

// 初期表示
document.addEventListener('DOMContentLoaded', () => {
    updateGrid();
});

// ページ遷移時にビューアを破棄
window.addEventListener('beforeunload', () => {
    viewers.forEach(viewer => {
        if (viewer && viewer.plugin) {
            viewer.plugin.dispose();
        }
    });
});
</script>
